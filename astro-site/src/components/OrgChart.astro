---
import type { Employee, TeamMember } from '../lib/csvReader';

interface Props {
  employees: Employee[];
  hierarchy: TeamMember[];
  teams: Map<string, Employee[]>;
}

const { employees, hierarchy, teams } = Astro.props;

const leadershipTeam = teams.get('Leadership') || [];
// Separate Mike and Vista for hierarchical display
const mike = leadershipTeam.find(e => e.name === 'Mike Duffy');
const vista = leadershipTeam.find(e => e.name === 'Vista Le');
const aiTeam = teams.get('AI Team') || [];
const aiPortfolioTeam = teams.get('AI Portfolio') || [];
const aiDevelopmentTeam = teams.get('AI Development') || [];
const safetyInsightsTeam = teams.get('Safety Insights') || [];
const substationTeam = teams.get('Substation Design Automation') || [];
const estimationAgentTeam = teams.get('Estimation Agent') || [];
const aiGovernanceTeam = teams.get('AI Governance') || [];
const aiTigerTeam = teams.get('AI Tiger Team') || [];
const dataAnalyticsTeam = teams.get('Data & Analytics') || [];

const dataTeams = new Map<string, Employee[]>();
['Spectrum', 'JDE', 'FleetIQ', 'PeopleIQ', 'OneStream', 'General Data Products', 'Deployment & Change Mgmt', 'Platform'].forEach(teamName => {
  const team = teams.get(teamName);
  if (team && team.length > 0) {
    dataTeams.set(teamName, team);
  }
});

function getEmployeeClass(employee: Employee): string {
  const classes = ['member-card'];
  if (employee.employmenttype === 'Contractor') {
    classes.push('contractor');
  } else if (employee.employmenttype === 'Employee') {
    classes.push('employee');
  } else if (employee.employmenttype === 'Borrowed Resource') {
    classes.push('borrowed');
  }
  return classes.join(' ');
}
---

<div class="org-chart">
  <!-- Mike Duffy Level -->
  {mike && (
    <>
      <div class="leadership-level">
        <div class="person-card leadership">
          <div class="person-name">{mike.name}</div>
          <div class="person-title">{mike.title}</div>
        </div>
      </div>
      <div class="connector"></div>
    </>
  )}

  <!-- Vista Le Level -->
  {vista && (
    <>
      <div class="leadership-level">
        <div class="person-card leadership">
          <div class="person-name">{vista.name}</div>
          <div class="person-title">{vista.title}</div>
        </div>
      </div>
      <div class="connector"></div>
    </>
  )}

  <!-- Main Teams Container -->
  <div class="main-teams">
    <!-- AI Team Section -->
    {(aiTeam.length > 0 || aiPortfolioTeam.length > 0 || aiDevelopmentTeam.length > 0 || safetyInsightsTeam.length > 0 || substationTeam.length > 0 || estimationAgentTeam.length > 0 || aiGovernanceTeam.length > 0 || aiTigerTeam.length > 0) && (
      <div class="team-container">
        <div class="team-header">AI Team</div>
        
        <!-- Top-level AI Team members -->
        {aiTeam.length > 0 && (
          <div class="team-members">
            {aiTeam.map(member => (
              <div class={getEmployeeClass(member)}>
                <div class="member-name">{member.name}</div>
                <div class="member-title">{member.title}</div>
              </div>
            ))}
          </div>
        )}

        <div class="sub-teams">
          <!-- AI Portfolio -->
          {aiPortfolioTeam.length > 0 && (
            <div class="sub-team">
              <div class="sub-team-header">AI Portfolio</div>
              <div class="team-members">
                {aiPortfolioTeam.map(member => (
                  <div class={getEmployeeClass(member)}>
                    <div class="member-name">{member.name}</div>
                    <div class="member-title">{member.title}</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <!-- AI Development -->
          {aiDevelopmentTeam.length > 0 && (
            <div class="sub-team">
              <div class="sub-team-header">AI Development</div>
              <div class="team-members">
                {aiDevelopmentTeam.map(member => (
                  <div class={getEmployeeClass(member)}>
                    <div class="member-name">{member.name}</div>
                    <div class="member-title">{member.title}</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <!-- Safety Insights -->
          {safetyInsightsTeam.length > 0 && (
            <div class="sub-team">
              <div class="sub-team-header">Safety Insights</div>
              <div class="team-members">
                {safetyInsightsTeam.map(member => (
                  <div class={getEmployeeClass(member)}>
                    <div class="member-name">{member.name}</div>
                    <div class="member-title">{member.title}</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <!-- Substation Design Automation -->
          {substationTeam.length > 0 && (
            <div class="sub-team">
              <div class="sub-team-header">Substation Design Automation</div>
              <div class="team-members">
                {substationTeam.map(member => (
                  <div class={getEmployeeClass(member)}>
                    <div class="member-name">{member.name}</div>
                    <div class="member-title">{member.title}</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <!-- Estimation Agent -->
          {estimationAgentTeam.length > 0 && (
            <div class="sub-team">
              <div class="sub-team-header">Estimation Agent</div>
              <div class="team-members">
                {estimationAgentTeam.map(member => (
                  <div class={getEmployeeClass(member)}>
                    <div class="member-name">{member.name}</div>
                    <div class="member-title">{member.title}</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <!-- AI Governance -->
          {aiGovernanceTeam.length > 0 && (
            <div class="sub-team">
              <div class="sub-team-header">AI Governance</div>
              <div class="team-members">
                {aiGovernanceTeam.map(member => (
                  <div class={getEmployeeClass(member)}>
                    <div class="member-name">{member.name}</div>
                    <div class="member-title">{member.title}</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <!-- AI Tiger Team -->
          {aiTigerTeam.length > 0 && (
            <div class="sub-team">
              <div class="sub-team-header">AI Tiger Team</div>
              <div class="team-members">
                {aiTigerTeam.map(member => (
                  <div class={getEmployeeClass(member)}>
                    <div class="member-name">{member.name}</div>
                    <div class="member-title">{member.title}</div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    )}

    <!-- Data & Analytics Team Section -->
    {dataAnalyticsTeam.length > 0 && (
      <div class="team-container">
        <div class="team-header">Data & Analytics</div>
        
        <!-- Main Data & Analytics team members -->
        <div class="team-members">
          {dataAnalyticsTeam.map(member => (
            <div class={getEmployeeClass(member)}>
              <div class="member-name">{member.name}</div>
              <div class="member-title">{member.title}</div>
            </div>
          ))}
        </div>

        <!-- Data Sub-teams -->
        <div class="sub-teams">
          {Array.from(dataTeams.entries()).map(([teamName, teamMembers]) => (
            <div class="sub-team">
              <div class="sub-team-header">{teamName}</div>
              <div class="team-members">
                {teamMembers.map(member => (
                  <div class={getEmployeeClass(member)}>
                    <div class="member-name">{member.name}</div>
                    <div class="member-title">{member.title}</div>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    )}
  </div>
</div>